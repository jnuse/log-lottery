# 这个工作流会完成 Node.js 依赖的全新安装、缓存/恢复、构建源代码，并使用 GitHub Actions 方式部署到 Pages。
name: Deploy to GitHub Pages via Actions

on:
  workflow_dispatch:
  # 如果需要推送到 main 分支时自动部署，可以取消下面这几行的注释
  # push:
  #   branches:
  #     - main

# 设置部署所需的权限
permissions:
  contents: read
  pages: write      # 允许 workflow 写入 Pages
  id-token: write   # 允许 workflow 请求 OIDC Token

jobs:
  # 构建任务 (build job)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm build

      - name: Create 404.html for SPA fallback
        run: cp dist/index.html dist/404.html

      # ⚠️ 注意：这里不再需要创建 CNAME 文件了！
      # 自定义域名是在 Settings -> Pages 中设置的，与部署流程解耦了。

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3 # 关键步骤：上传构建产物
        with:
          path: ./dist # 指定你的构建输出目录

  # 部署任务 (deploy job)
  deploy:
    # 部署任务需要等待构建任务成功完成
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # 输出部署后的 URL
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # 关键步骤：执行部署
